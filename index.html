<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Poker Split ‚Äî Canvas Preview</title>
<meta name="theme-color" content="#0A0A0A" />
<script>
  const _metaTheme = document.querySelector('meta[name="theme-color"]');
  function _applyThemeColor(){
    const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    _metaTheme.setAttribute('content', dark ? '#0c0c0d' : '#ffffff');
  }
  _applyThemeColor();
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', _applyThemeColor);
</script>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Poker Split" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/manifest.webmanifest" />

<style>
  :root{
    --fg:#0b0b0b;--muted:#6a6a6a;--line:#e5e5e5;--bg:#ffffff;--card:#ffffff;--hint:#f7f7f7;
    --accent:#2860ff;--input-bg:#ffffff;--input-border:#d7d7d7;--pill-bg:#eef4ff;--pill-border:#d9e2ff;
    --row-active:#f2f8ff;--row-alt:#fbfbfd;--shadow:0 1px 0 rgba(0,0,0,.02);--sticky-h:68px;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#f5f5f7;--muted:#a1a1a7;--line:#2a2a2e;--bg:#0c0c0d;--card:#121214;--hint:#161617;
      --accent:#8ab1ff;--input-bg:#0f0f11;--input-border:#2a2a2e;--pill-bg:#22252d;--pill-border:#3b4150;
      --row-active:#0f1b28;--row-alt:#14161b;--shadow:0 1px 0 rgba(0,0,0,.25);
    }
  }

  html,body{background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45;margin:0;padding:0}
  body{max-width:980px;margin:0 auto;padding:0 12px calc(var(--sticky-h) + env(safe-area-inset-bottom, 0px));overflow-x:hidden}
  h1{font-size:1.28rem;margin:0}
  h3{margin:0 0 8px;font-size:1.02rem}
  .small{font-size:.92rem;color:var(--muted)}

  /* top bar */
  .topbar{
    position:sticky;
    top:0;
    z-index:900;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px 0 10px;
    background:var(--bg);
    backdrop-filter:blur(20px);
    border-bottom:1px solid color-mix(in srgb,var(--line) 70%, transparent);
    transition:transform .18s ease-out;
  }
  .topbar-hidden{
    transform:translateY(-100%);
  }

  .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
  .row>*{flex:1;min-width:0}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .card{border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;background:var(--card);box-shadow:var(--shadow);overflow:hidden}

  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill-bg);border:2px solid var(--pill-border);padding:10px 14px;border-radius:9999px;margin:6px 8px 0 0;font-size:1rem;font-weight:600;line-height:1;color:var(--fg);user-select:none;-webkit-tap-highlight-color:transparent;transform:translateZ(0);min-width:clamp(72px, calc(var(--len,8)*0.62ch + 28px), 180px);justify-content:center}
  .pill.active{background:var(--accent);border-color:var(--accent);color:#fff}

  input,select,button{font:inherit;padding:10px 12px;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--fg);max-width:100%;box-sizing:border-box;transition:.15s border-color,.15s box-shadow,.15s transform}
  input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent)}
  button{cursor:pointer;white-space:nowrap}
  button:active{transform:translateY(1px)}
  .btn{border:1px solid var(--input-border);background:var(--input-bg)}
  .btn.primary{background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 95%, #fff 0%) 0%, var(--accent) 100%);color:#fff;border-color:var(--accent);box-shadow:0 6px 16px rgba(40,96,255,.20)}
  .btn.link{background:var(--pill-bg);border-color:var(--pill-border);font-weight:600}
  .btn.small-btn{padding:6px 10px;font-size:.9rem;border-radius:999px}

  .profit{display:inline-block;text-align:right;min-width:80px;transition:color .15s ease-out}
  .profit-win{color:#2ecc71;}
  .profit-loss{color:#ff6b6b;}

  /* compacte stepper: input + -10 + +10 in √©√©n rij */
  .stepper{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .stepper input{
    flex:1 1 auto;
    min-width:0;
  }
  .stepper button{
    min-width:46px;
  }

  /* resultaat-rij (W/V + AB + delete) */
  .result-wrap{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:flex-start;
    flex-wrap:nowrap;
    padding:4px 10;           /* geen links/rechts padding ‚Äì dat doet de <td> al */
    border-radius:999px;
    background:transparent;
    transition:background .15s ease-out;
  }

  .result-wrap.result-win{
    background:rgba(46,204,113,0.10);
  }
  .result-wrap.result-loss{
    background:rgba(231,76,60,0.10);
  }
  .result-left{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .ab-label{
    display:inline-flex;
    align-items:center;
    gap:0px;             /* minder ruimte tussen checkbox en "AB?" */
    font-size:.85rem;
    color:var(--muted);
    white-space:nowrap;
  }

    /* Checkbox zelf: marge weg + kleiner formaat */
  .ab-label input[type="checkbox"]{
    margin:0;
    width:16px;
    height:16px;
    padding:0;
    box-sizing:border-box;
  }

  .kpi{background:var(--hint);border:1px solid var(--line);border-radius:12px;padding:10px;margin:4px 0;display:flex;gap:12px;flex-wrap:wrap}
  .kpi > div{white-space:nowrap}

  .sticky{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--line);padding:10px 12px calc(10px + env(safe-area-inset-bottom, 0px));display:flex;align-items:center;gap:10px;z-index:1000;min-height:var(--sticky-h);max-width:980px;margin:0 auto}
  .sticky .spacer{flex:1}
  #lastSaved.good{color:#2ecc71} #lastSaved.warn{color:#f39c12} #lastSaved.bad{color:#e74c3c}

  #presetWrap{display:flex;flex-wrap:wrap;gap:8px}
  #presetWrap > .pill{flex:0 0 auto}

  /* prullenbak-knop, slot even breed als +10 */
  .icon-btn{
    padding:0;
    min-width:46px;
    height:34px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:1rem;
  }

  /* Settings layout */
  .settings-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(160px,1fr));
    gap:12px;
    align-items:end
  }
  .settings-grid > div label{display:block;margin:0 0 6px;color:var(--muted);font-weight:600}
  @media (min-width:800px){
    .settings-grid{grid-template-columns:repeat(4,minmax(160px,1fr))}
  }
  .settings-bottom{display:grid;grid-template-columns:minmax(320px,1fr) minmax(220px,1fr);gap:12px;align-items:flex-start}
  @media (max-width:800px){.settings-bottom{grid-template-columns:1fr}}

  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;box-sizing:border-box;border-radius:12px;overflow:hidden}
  th,td{border:1px solid var(--line);padding:10px;vertical-align:middle;box-sizing:border-box}
  th{background:var(--hint);text-align:left}
  tbody tr:nth-child(even){background:var(--row-alt)}
  tbody tr:hover{background:color-mix(in srgb, var(--row-active) 55%, transparent)}
  tr.active-row{background:var(--row-active)}
  td.right input{width:100%;min-width:70px}

  @media (max-width:640px){
    table thead{display:none}
    table, tbody, tr, td{display:block;width:100%;box-sizing:border-box}
    tr{
      border:1px solid var(--line);
      border-radius:12px;
      margin:10px 0;
      padding:4px;
      background:var(--card);
      overflow:hidden;
    }
    td{
      border:none;
      padding:4px 10px;
      display:grid;
      grid-template-columns:80px minmax(0,1fr);
      align-items:center;
      column-gap:8px;
    }
    td[data-label]::before{
      content:attr(data-label) ": ";
      font-weight:600;
      color:var(--muted);
      grid-column:1;
    }
    td > *{grid-column:2}
    td.right{display:grid}
    input,select,button{
      padding:7px 9px;
      font-size:.95rem;
    }
  }

  .card-header-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:4px;
  }
</style>
</head>
<body>

<header id="topBar" class="topbar">
  <h1>üí∏ Poker Split</h1>
  <button id="openStats" class="btn link">üìä Statistieken</button>
</header>

<p class="small">Vul je spelers, inzet en eindbedrag in. Klik onderin op <b>Berekenen & Tikkies</b>. Alles werkt hier live.</p>

<!-- Presets -->
<div class="card">
  <h3>Spelers</h3>
  <div id="presetWrap"></div>
  <div class="row">
    <div>
      <label>Custom speler</label>
      <div class="actions">
        <input id="customName" placeholder="Naam" />
        <button id="addCustom" class="btn">Toevoegen</button>
      </div>
    </div>
    <div>
      <label>Standaard inzet</label>
      <input id="defaultBuyin" type="number" step="0.01" inputmode="decimal" value="10" />
    </div>
  </div>
  <div class="actions">
    <button id="selectAll" class="btn">Selecteer iedereen</button>
    <button id="clearAll" class="btn">Alles leeg</button>
    <button id="pasteBtn" class="btn">Plak lijst‚Ä¶</button>
  </div>
</div>

<!-- Grid -->
<div class="card">
  <h3>Invoer per speler</h3>
  <div class="table-wrap">
    <table id="grid">
      <thead>
        <tr>
          <th>Speler</th>
          <th>Inzet</th>
          <th>Eind</th>
          <th>Resultaat</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="actions" style="margin-top:8px">
    <button id="fillBuyin" class="btn">Zet alle inzet = standaard</button>
    <button id="equalizeEnd" class="btn">Zet eind = inzet</button>
    <!-- globale -10 / +10 knoppen verwijderd -->
  </div>
</div>

<!-- Instellingen -->
<div class="card">
  <div class="row settings-grid">
    <div><label>Omschrijving</label><input id="desc" value="Pokeravond" /></div>
    <div><label>Afronden</label>
      <select id="round">
        <option value="0.01">Cent (0,01)</option>
        <option value="0.05">5 cent (0,05)</option>
        <option value="0.10">10 cent (0,10)</option>
        <option value="1">Euro (1,00)</option>
      </select>
    </div>
    <div><label>Strategie</label>
      <select id="strategy">
        <option value="largest">Grootste</option>
        <option value="typed">Invoer-volgorde</option>
        <option value="proportional">Proportioneel</option>
      </select>
    </div>
    <div><label>Perspectief</label>
      <select id="perspective">
        <option value="receiver">Per ontvanger</option>
        <option value="raw">Transacties</option>
        <option value="payer">Per betaler</option>
      </select>
    </div>
  </div>
  <div class="row settings-bottom">
    <div class="kpi">
      <div>Som: <b id="kTotal">‚Ç¨ 0,00</b></div>
      <div>Ontvangers: <b id="kPos">‚Ç¨ 0,00</b></div>
      <div>Betalers: <b id="kNeg">‚Ç¨ 0,00</b></div>
    </div>
    <div style="flex:1">
      <label class="small">
        <input type="checkbox" id="autoBalance" checked />
        Som auto-balanceren (random uit aangevinkte spelers)
      </label>
    </div>
  </div>
</div>

<!-- Resultaat -->
<div class="card">
  <div class="card-header-row">
    <h3>Resultaat</h3>
    <button id="shareResult" class="btn small-btn" disabled>üì§ Delen</button>
  </div>
  <div id="result"></div>
</div>

<!-- Sticky actiebar -->
<div class="sticky">
  <div id="lastSaved" class="small">Autosave ‚úì</div>
  <div class="spacer"></div>
  <button id="saveSession" class="btn">Opslaan</button>
  <button id="calc" class="btn primary">Berekenen & Tikkies</button>
</div>

<script>
// ===== Utils
const PRESETS = ['Jordy','Ronan','Tyson','Julian','Glenn','Max','Bram','Hanifi','Jordi','Vince','Aron','Jeroen'];
function euro(n){ return n.toLocaleString('nl-NL',{style:'currency',currency:'EUR'}); }
function parseNum(v){ if(v===''||v==null)return NaN; let s=String(v).replace(',','.'); const n=Number(s); return Number.isFinite(n)?n:NaN; }
function roundTo(x, step){ const inv=1/step; return Math.round(x*inv)/inv; }
function haptic(type='light'){ const V=navigator.vibrate?.bind(navigator)||null; if(!V)return; if(type==='success')return V([12,20,12]); if(type==='error')return V([1,40,1,40,1]); if(type==='impact')return V(24); return V(10); }
function djb2(str){ let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i); h|=0; } return (h>>>0).toString(36); }

// ===== UI helpers
const $grid = document.querySelector('#grid tbody');
let activeRowIndex = 0;
let lastShareText = '';

function rowHTML(name='', buyin='', end=''){
  return `
    <td data-label="Speler"><input class="name" placeholder="Naam" value="${name}"></td>
    <td class="right" data-label="Inzet">
      <div class="stepper">
        <input class="buyin" type="number" inputmode="decimal" step="0.01" placeholder="0,00" value="${buyin}">
        <button data-step="buy,-10">‚àí10</button>
        <button data-step="buy,10">+10</button>
      </div>
    </td>
    <td class="right" data-label="Eind">
      <div class="stepper">
        <input class="end" type="number" inputmode="decimal" step="0.01" placeholder="0,00" value="${end}">
        <button data-step="end,-10">‚àí10</button>
        <button data-step="end,10">+10</button>
      </div>
    </td>
    <td class="right" data-label="Resultaat">
      <div class="result-wrap">
        <div class="result-left">
          <span class="profit mono">‚Ç¨ 0,00</span>
          <label class="ab-label"><input type="checkbox" class="ab" checked> AB?</label>
        </div>
        <button data-action="del" title="Verwijder" class="icon-btn">üóëÔ∏è</button>
      </div>
    </td>`;
}

function addRow(name='', buyin='', end=''){
  const tr = document.createElement('tr');
  tr.innerHTML = rowHTML(name,buyin,end);
  $grid.appendChild(tr);
  recalcRow(tr);
  syncPills();
  saveStateDebounced();
  haptic('success');
}

function setActiveRow(tr){
  Array.from($grid.children).forEach(r=>r.classList.remove('active-row'));
  tr.classList.add('active-row');
  activeRowIndex = Array.from($grid.children).indexOf(tr);
}

function stepValue(inp, delta){
  const cur = parseNum(inp.value)||0;
  inp.value = (cur + delta).toFixed(2);
  inp.dispatchEvent(new Event('input', { bubbles: true }));
  inp.focus(); inp.select();
}

function recalcRow(tr){
  const buy = parseNum(tr.querySelector('.buyin').value)||0;
  const end = parseNum(tr.querySelector('.end').value)||0;
  const prof = end - buy;
  tr.dataset.profit = prof.toFixed(2);

  const profitEl = tr.querySelector('.profit');
  const wrapEl = tr.querySelector('.result-wrap');
  profitEl.textContent = euro(prof);
  profitEl.classList.toggle('profit-win', prof > 0.005);
  profitEl.classList.toggle('profit-loss', prof < -0.005);
  wrapEl.classList.toggle('result-win', prof > 0.005);
  wrapEl.classList.toggle('result-loss', prof < -0.005);

  recalcTotals();
  saveStateDebounced();
}

function getEntries(){
  return Array.from($grid.children).map((tr,i)=>{
    const name = tr.querySelector('.name').value.trim() || `Speler ${i+1}`;
    const amt = parseNum(tr.dataset.profit||'0')||0;
    const ab = tr.querySelector('.ab')?.checked ?? true;
    return {name, amount: amt, order:i, ab};
  }).filter(e=>e.name);
}

function recalcTotals(){
  const entries = getEntries();
  const total = entries.reduce((a,e)=>a+e.amount,0);
  const pos = entries.filter(e=>e.amount>0).reduce((a,e)=>a+e.amount,0);
  const neg = entries.filter(e=>e.amount<0).reduce((a,e)=>a+e.amount,0);
  document.getElementById('kTotal').textContent = euro(total);
  document.getElementById('kPos').textContent = euro(pos);
  document.getElementById('kNeg').textContent = euro(neg);
  const $ls = document.getElementById('lastSaved');
  $ls.classList.remove('good','warn','bad');
  const drift = Math.abs(total);
  if(drift < 0.005){ $ls.textContent='Som klopt ‚úì'; $ls.classList.add('good'); }
  else { $ls.textContent = 'Som wijkt af ' + euro(drift); $ls.classList.add('warn'); }
}

$grid.addEventListener('click', (e)=>{
  const tr = e.target.closest('tr'); if (!tr) return;
  setActiveRow(tr);
  const stepAttr = e.target.getAttribute('data-step');
  const actAttr = e.target.getAttribute('data-action');
  if (stepAttr){
    const [which, deltaStr] = stepAttr.split(',');
    const delta = Number(deltaStr);
    const targetInput = tr.querySelector(which==='buy'?'.buyin':'.end');
    stepValue(targetInput, delta);
    haptic('light');
  } else if (actAttr === 'del'){
    tr.remove(); recalcTotals(); syncPills(); saveState(); haptic('error');
  }
});
$grid.addEventListener('focusin', (e)=>{ const tr = e.target.closest('tr'); if (tr) setActiveRow(tr); });
$grid.addEventListener('input', (e)=>{ const tr = e.target.closest('tr'); if (!tr) return; if (e.target.matches('.buyin,.end,.name,.ab')) recalcRow(tr); });

// Bulk
const $defaultBuyin = document.getElementById('defaultBuyin');
document.getElementById('fillBuyin').addEventListener('click', ()=>{
  const val=$defaultBuyin.value;
  $grid.querySelectorAll('.buyin').forEach(i=>{ i.value=val; i.dispatchEvent(new Event('input', { bubbles: true })); });
  haptic('impact');
});
document.getElementById('equalizeEnd').addEventListener('click', ()=>{
  $grid.querySelectorAll('tr').forEach(tr=>{
    const buy=tr.querySelector('.buyin'); const end=tr.querySelector('.end');
    end.value=buy.value; end.dispatchEvent(new Event('input', { bubbles: true }));
  });
  haptic('impact');
});

// globale -10/+10 bestaan niet meer; alleen nudgeActive helper laten staan als we later iets willen
function nudgeActive(delta){
  const rows=Array.from($grid.children); if(!rows.length) return;
  const tr=rows[Math.max(0,Math.min(activeRowIndex,rows.length-1))];
  const end=tr.querySelector('.end'); const cur=parseNum(end.value)||0;
  end.value=(cur+delta).toFixed(2);
  end.dispatchEvent(new Event('input', { bubbles: true }));
  end.focus(); end.select();
}

// Presets
const $presetWrap=document.getElementById('presetWrap');
function normName(s){return (s||'').trim().toLowerCase();}
function findRowsByName(name){ const n=normName(name); return Array.from($grid.children).filter(r=>normName(r.querySelector('.name').value)===n); }
function rowExists(name){ return findRowsByName(name).length>0; }
function removeRowsByName(name){ findRowsByName(name).forEach(r=>r.remove()); recalcTotals(); syncPills(); saveState(); }
function renderPresets(){
  $presetWrap.innerHTML='';
  PRESETS.forEach(name=>{
    const el=document.createElement('span'); el.className='pill'; el.textContent=name; el.style.setProperty('--len', String(name.length));
    if(rowExists(name)) el.classList.add('active');
    el.addEventListener('click',()=>{
      if(el.classList.contains('active')){ removeRowsByName(name); el.classList.remove('active'); }
      else { if(!rowExists(name)) addRow(name, $defaultBuyin.value, ''); el.classList.add('active'); }
    });
    $presetWrap.appendChild(el);
  });
}
function syncPills(){
  Array.from($presetWrap.children).forEach(p=>{
    const name=p.textContent.trim().toLowerCase();
    const exists = Array.from($grid.children)
      .some(r => (r.querySelector('.name').value||'').trim().toLowerCase()===name);
    p.classList.toggle('active', exists);
  });
}

document.getElementById('selectAll').addEventListener('click', ()=>{
  PRESETS.forEach(n=>{ if(!rowExists(n)) addRow(n, $defaultBuyin.value, ''); });
  syncPills(); haptic('impact');
});
document.getElementById('clearAll').addEventListener('click', ()=>{
  $grid.innerHTML=''; Array.from($presetWrap.children).forEach(c=>c.classList.remove('active'));
  recalcTotals(); syncPills(); saveState(); haptic('error');
});
document.getElementById('addCustom').addEventListener('click', ()=>{
  const v=document.getElementById('customName').value.trim(); if(!v) return;
  addRow(v, $defaultBuyin.value, ''); document.getElementById('customName').value='';
  haptic('success');
});

// Paste
const $pasteBtn = document.getElementById('pasteBtn');
$pasteBtn.addEventListener('click', async ()=>{
  try{ const txt = await navigator.clipboard.readText(); if(!txt) return alert('Klembord is leeg.'); parsePaste(txt); }
  catch(e){ const txt = prompt('Plak hier je lijst (Naam, inzet, eind) of (Naam, saldo):'); if(txt) parsePaste(txt); }
});
function parseEuro(s){ return parseNum(String(s).replace(/[‚Ç¨\s]/g,'').replace(',','.')); }
function parsePaste(txt){
  const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const raw of lines){
    const parts = raw.split(/[;,|\t]/).map(s=>s.trim());
    if(parts.length>=3){
      const [name,buy,end] = [parts[0], parseEuro(parts[1]), parseEuro(parts[2])];
      addRow(name, isNaN(buy)?'':buy, isNaN(end)?'':end);
    } else if (parts.length===2){
      const [name, saldo] = [parts[0], parseEuro(parts[1])];
      const buy = parseEuro($defaultBuyin.value)||0;
      const end = buy + (isNaN(saldo)?0:saldo);
      addRow(name, buy, end);
    }
  }
  saveStateDebounced();
}

// ===== Berekenen + random autobalance
function settle(entries, rounding, strategy){
  let creditors=[], debtors=[], sum=0;
  for(const e of entries){
    const a = roundTo(e.amount, rounding); sum += a;
    if (a>1e-9) creditors.push({name:e.name, amount:a, order:e.order});
    else if (a<-1e-9) debtors.push({name:e.name, amount:-a, order:e.order});
  }
  if (strategy==='largest'){
    creditors.sort((a,b)=>b.amount-a.amount);
    debtors.sort((a,b)=>b.amount-a.amount);
  } else {
    creditors.sort((a,b)=>a.order-b.order);
    debtors.sort((a,b)=>a.order-b.order);
  }

  const transfers=[];
  if (strategy==='proportional'){
    const totalDebt0 = debtors.reduce((a,d)=>a+d.amount,0);
    for(const c of creditors){
      let remaining=c.amount;
      for(const d of debtors){
        if(d.amount<=1e-9||remaining<=1e-9) continue;
        const share=roundTo(c.amount*(d.amount/totalDebt0),rounding);
        const amount=Math.min(share,d.amount,remaining);
        const amtR=roundTo(amount,rounding);
        if(amtR>0){
          transfers.push({from:d.name,to:c.name,amount:amtR});
          d.amount=roundTo(d.amount-amtR,rounding);
          remaining=roundTo(remaining-amtR,rounding);
        }
      }
    }
  } else {
    let i=0,j=0;
    while(i<debtors.length && j<creditors.length){
      const d=debtors[i], c=creditors[j];
      const amount=Math.min(d.amount,c.amount);
      const amtR=roundTo(amount,rounding);
      if(amtR>0){
        transfers.push({from:d.name,to:c.name,amount:amtR});
        d.amount=roundTo(d.amount-amtR,rounding);
        c.amount=roundTo(c.amount-amtR,rounding);
      }
      if(d.amount<=1e-9) i++;
      if(c.amount<=1e-9) j++;
    }
  }
  const residual=roundTo(sum,rounding);
  return {transfers,residual};
}

function render(transfers, desc, perspective){
  const out=document.getElementById('result');
  out.innerHTML='';
  if(!transfers.length){
    out.innerHTML='<p class="small">Geen transacties nodig üéâ</p>';
    return;
  }
  if(perspective==='raw'){
    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Van</th><th>Naar</th><th class="right">Bedrag</th></tr></thead><tbody></tbody>';
    const tb=tbl.querySelector('tbody');
    transfers.forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.from}</td><td>${t.to}</td><td class="right">${euro(t.amount)}</td>`;
      tb.appendChild(tr);
    }); out.appendChild(tbl);
  } else {
    const group={};
    transfers.forEach(t=>{ const key = perspective==='receiver'? t.to : t.from; (group[key]??=[]).push(t); });
    Object.keys(group).sort().forEach(name=>{
      const h=document.createElement('h4'); h.textContent = name + (perspective==='receiver'?' ‚Äî stuur Tikkies naar:':' ‚Äî jij betaalt aan:');
      out.appendChild(h);
      const tbl=document.createElement('table');
      tbl.innerHTML='<thead><tr><th>Persoon</th><th class="right">Bedrag</th></tr></thead><tbody></tbody>';
      const tb=tbl.querySelector('tbody');
      group[name].forEach(t=>{
        const other = perspective==='receiver'? t.from : t.to;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${other}</td><td class="right">${euro(t.amount)}</td>`;
        tb.appendChild(tr);
      }); out.appendChild(tbl);
    });
  }
}

function formatShareText(entries, transfers, desc){
  const now = new Date();
  const dateStr = now.toLocaleString('nl-NL',{dateStyle:'short', timeStyle:'short'});
  const lines = [];
  lines.push(`üí∏ ${desc}`);
  lines.push(`üìÖ ${dateStr}`);
  lines.push('');
  lines.push('Resultaat per speler:');
  entries.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(e=>{
    const sign = e.amount>0 ? '+' : '';
    lines.push(`‚Ä¢ ${e.name}: ${sign}${euro(e.amount)}`);
  });
  lines.push('');
  if(transfers.length){
    lines.push('Tikkies:');
    transfers.forEach(t=>{
      lines.push(`‚Ä¢ ${t.from} ‚Üí ${t.to}: ${euro(t.amount)}`);
    });
  } else {
    lines.push('Niemand hoeft wat te betalen üéâ');
  }
  lines.push('');
  lines.push('Verzonden met Poker Split');
  return lines.join('\n');
}


document.getElementById('calc').addEventListener('click', ()=>{
  const desc=document.getElementById('desc').value||'Poker Split';
  const rounding=Number(document.getElementById('round').value);
  const strategy=document.getElementById('strategy').value;
  const perspective=document.getElementById('perspective').value;
  const auto=document.getElementById('autoBalance').checked;

  let entries=getEntries();
  if(auto && entries.length){
    const sum=roundTo(entries.reduce((a,e)=>a+e.amount,0),0.01);
    if(Math.abs(sum)>0.0001){
      const sign = sum>0 ? +1 : -1;
      let pool = entries.filter(e => e.ab && (sign>0 ? e.amount>0 : e.amount<0));
      if(!pool.length) pool = entries.filter(e => e.ab);
      const picked = pool[Math.floor(Math.random()*pool.length)] || entries[0];
      picked.amount = roundTo(picked.amount - sum, 0.01);
      document.getElementById('lastSaved').textContent = `Auto-balance op ${picked.name}: ${euro(-sum)}`;
    }
  }
  const res=settle(entries, rounding, strategy);
  render(res.transfers, desc, perspective);

  // share-tekst voorbereiden
  lastShareText = formatShareText(entries, res.transfers, desc);
  const shareBtn = document.getElementById('shareResult');
  shareBtn.disabled = !lastShareText;
  haptic('impact');
});

// Deel-knop
document.getElementById('shareResult').addEventListener('click', async ()=>{
  if(!lastShareText){
    alert('Bereken eerst de resultaten.');
    return;
  }
  const text = lastShareText;
  if(navigator.share){
    try{
      await navigator.share({ text });
    }catch(e){
      // user cancel, geen probleem
    }
  }else{
    const waUrl = 'https://wa.me/?text=' + encodeURIComponent(text);
    window.open(waUrl, '_blank');
  }
});

// ===== IndexedDB (sessions)
const DB_NAME = 'poker_split_history_v1';
const STORE = 'sessions';
let db;
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE,{keyPath:'sessionId'});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function putSession(session){
  db = db || await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(session);
    tx.oncomplete=resolve;
    tx.onerror=()=>reject(tx.error);
  });
}
async function persist(){ try{ if(navigator.storage && navigator.storage.persist) await navigator.storage.persist(); }catch(e){} }
persist();

function makeSessionId(desc, players){
  const ts = new Date();
  const pad = n => String(n).padStart(2,'0');
  const stamp = `${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}`;
  const core = JSON.stringify(players.slice().sort((a,b)=>a.name.localeCompare(b.name)));
  return `${stamp}-${djb2(desc+'|'+core)}`;
}

// Opslaan -> buyin/eind/netto per speler
document.getElementById('saveSession').addEventListener('click', async ()=>{
  const desc = document.getElementById('desc').value || 'Pokeravond';
  const players = Array.from($grid.children).map((tr,i)=>{
    const name = tr.querySelector('.name').value.trim() || `Speler ${i+1}`;
    if(!name) return null;
    const buy = parseNum(tr.querySelector('.buyin').value)||0;
    const end = parseNum(tr.querySelector('.end').value)||0;
    const net = end - buy;
    return {
      name,
      buyin: Number(buy.toFixed(2)),
      end:   Number(end.toFixed(2)),
      net:   Number(net.toFixed(2))
    };
  }).filter(Boolean);
  if(!players.length){ alert('Geen spelers ingevuld.'); return; }
  const session = {
    sessionId: makeSessionId(desc, players),
    date: new Date().toISOString(),
    desc,
    players
  };
  try{
    await putSession(session);
    document.getElementById('lastSaved').textContent = 'Opgeslagen ‚úì';
    haptic('success');
  }catch(e){
    document.getElementById('lastSaved').textContent = 'Opslaan mislukt';
    haptic('error');
  }
});

// Nav naar stats
document.getElementById('openStats').addEventListener('click', ()=>{ location.href='stats.html'; });

// ===== Local autosave
const KEY='poker_split_canvas_state_v4';
function saveState(){
  const state={
    players:Array.from($grid.children).map(tr=>({
      name:tr.querySelector('.name').value,
      buyin:tr.querySelector('.buyin').value,
      end:tr.querySelector('.end').value,
      ab: tr.querySelector('.ab')?.checked
    })),
    desc:document.getElementById('desc').value,
    round:document.getElementById('round').value,
    strategy:document.getElementById('strategy').value,
    perspective:document.getElementById('perspective').value,
    defaultBuyin:document.getElementById('defaultBuyin').value,
    autoBalance:document.getElementById('autoBalance').checked
  };
  try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
  document.getElementById('lastSaved').textContent='Autosave ‚úì';
}
let saveTimer=null;
function saveStateDebounced(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveState, 250); }

function restoreState(){
  renderPresets();
  try{
    const raw=localStorage.getItem(KEY);
    if(raw){
      const s=JSON.parse(raw);
      (s.players||[]).forEach(p=>{
        addRow(p.name,p.buyin,p.end);
        const tr = $grid.lastElementChild;
        const ab = tr.querySelector('.ab');
        if (ab && typeof p.ab!=='undefined') ab.checked = !!p.ab;
        recalcRow(tr);
      });
      document.getElementById('desc').value=s.desc||'Pokeravond';
      document.getElementById('round').value=s.round||'0.01';
      document.getElementById('strategy').value=s.strategy||'largest';
      document.getElementById('perspective').value=s.perspective||'receiver';
      document.getElementById('defaultBuyin').value=s.defaultBuyin||'10';
      document.getElementById('autoBalance').checked = (typeof s.autoBalance==='boolean') ? s.autoBalance : true;
      recalcTotals();
    }
  }catch(e){}
  if(!$grid.children.length){ addRow('Julian', 10, ''); addRow('Tyson', 10, ''); }
}
restoreState();

// ===== Topbar scroll-gedrag
let lastScrollY = window.scrollY;
window.addEventListener('scroll', () => {
  const bar = document.getElementById('topBar');
  if(!bar) return;
  const y = window.scrollY;
  if (y > lastScrollY + 10 && y > 40){
    bar.classList.add('topbar-hidden');
  } else if (y < lastScrollY - 10 || y < 40){
    bar.classList.remove('topbar-hidden');
  }
  lastScrollY = y;
});

// ===== Service worker registratie (voor PWA/offline)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
</script>
</body>
</html>
