<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Poker Split ‚Äî Statistieken</title>
<meta name="theme-color" content="#0A0A0A" />
<script>
  const _metaTheme = document.querySelector('meta[name="theme-color"]');
  function _applyThemeColor(){
    const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    _metaTheme.setAttribute('content', dark ? '#0c0c0d' : '#ffffff');
  }
  _applyThemeColor();
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', _applyThemeColor);
</script>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Poker Split" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

<!-- Chart.js via CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --fg:#0b0b0b;--muted:#6a6a6a;--line:#e5e5e5;--bg:#ffffff;--card:#ffffff;--hint:#f7f7f7;
    --accent:#2860ff;--input-bg:#ffffff;--input-border:#d7d7d7;--pill-bg:#eef4ff;--pill-border:#d9e2ff;
    --shadow:0 1px 0 rgba(0,0,0,.02);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#f5f5f7;--muted:#a1a1a7;--line:#2a2a2e;--bg:#0c0c0d;--card:#121214;--hint:#161617;
      --accent:#8ab1ff;--input-bg:#0f0f11;--input-border:#2a2a2e;--pill-bg:#22252d;--pill-border:#3b4150;
      --shadow:0 1px 0 rgba(0,0,0,.25);
    }
  }

  html,body{background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45;margin:0;padding:0}
  body{max-width:980px;margin:0 auto;padding:0 12px 24px;overflow-x:hidden}
  h1{font-size:1.28rem;margin:0}
  h2{font-size:1.08rem;margin:0 0 8px}
  .small{font-size:.92rem;color:var(--muted)}
  .hidden{display:none}

  /* Animaties */
  @keyframes fadeInUp {
    from { opacity:0; transform:translateY(6px); }
    to   { opacity:1; transform:translateY(0); }
  }

  /* top bar */
  .topbar{
    position:sticky;
    top:0;
    z-index:900;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 0 12px;
    background:var(--bg);
    backdrop-filter:blur(20px);
    border-bottom:1px solid color-mix(in srgb,var(--line) 70%, transparent);
  }

  .btn{font:inherit;padding:9px 14px;border-radius:999px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--fg);cursor:pointer;white-space:nowrap;display:inline-flex;align-items:center;gap:6px;transition:background .18s ease,border-color .18s ease,transform .1s ease,box-shadow .1s ease}
  .btn:active{transform:scale(.97)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 6px 16px rgba(40,96,255,.25)}
  .btn.ghost{background:var(--pill-bg);border-color:var(--pill-border)}
  .btn.small{padding:6px 10px;font-size:.9rem}
  .btn.danger{border-color:#e74c3c;color:#e74c3c;background:transparent}

  .card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 12px 10px;
    margin:10px 0;
    background:var(--card);
    box-shadow:var(--shadow);
    animation:fadeInUp .5s ease-out;
    animation-fill-mode:both;
  }

  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .muted{color:var(--muted)}

  .kpi-row{display:flex;flex-wrap:wrap;gap:10px 16px;margin-top:6px}
  .kpi-pill{background:var(--hint);border-radius:999px;padding:6px 10px;font-size:.88rem}

  .highlights{margin-top:4px;display:flex;flex-direction:column;gap:3px;font-size:.9rem}

  /* Leaderboard ‚Äì mobiele cards */
  .leaderboard-list{margin:6px 0 2px}
  .player-card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px 12px;
    margin:6px 0;
    background:var(--card);
    cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .player-card:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 18px rgba(0,0,0,.28);
    border-color:color-mix(in srgb,var(--accent) 40%, var(--line));
  }
  .player-card[data-player]:active{
    transform:scale(.98);
  }
  .pc-header{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    margin-bottom:4px;
  }
  .pc-name{font-weight:600}
  .pc-total{font-weight:700}
  .pc-total.pos{color:#2ecc71}
  .pc-total.neg{color:#e74c3c}
  .pc-row{
    display:flex;
    flex-wrap:wrap;
    gap:4px 12px;
    margin-top:3px;
  }
  .pc-row span{
    font-size:.85rem;
    color:var(--muted);
  }
  .pc-row span b{
    font-weight:600;
    color:var(--fg);
  }

  /* History */
  details.session{
    border:1px solid var(--line);
    border-radius:14px;
    margin:6px 0;
    background:var(--card);
    overflow:hidden;
    transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
  }
  details.session[open]{box-shadow:var(--shadow);border-color:color-mix(in srgb,var(--accent) 25%, var(--line));}
  details.session > summary{
    list-style:none;
    padding:8px 12px;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  details.session > summary::-webkit-details-marker{display:none}
  .session-main{display:flex;flex-direction:column;gap:2px}
  .session-line{font-size:.9rem}
  .session-line b{font-weight:600}
  .session-total{font-weight:600;font-size:.95rem}
  .session-body{padding:6px 12px 10px;border-top:1px solid var(--line);font-size:.9rem}
  .session-table{width:100%;border-collapse:collapse;border-spacing:0;margin-top:4px}
  .session-table th,.session-table td{padding:4px 4px;font-size:.86rem;text-align:left}
  .session-table th{color:var(--muted);font-weight:600}
  .session-table td.amount{text-align:right}

  /* Backup */
  .backup-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;align-items:center}

  /* Charts */
  .chart-block{display:flex;flex-direction:column;gap:4px}
  .chart-box{
    position:relative;
    width:100%;
    height:200px;
  }
  .chart-box.large{height:220px;}
  .chart-box canvas{
    width:100% !important;
    height:100% !important;
    border-radius:12px;
    background:var(--card);
  }

  /* Heatmap */
  .heatmap{
    margin-top:10px;
  }
  .heat-row{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-top:4px;
  }
  .heat-dot{
    width:12px;
    height:12px;
    border-radius:50%;
    border:1px solid color-mix(in srgb,var(--line) 70%, transparent);
    background:hsl(210,80%,calc(88% - (var(--level,0) * 40%)));
  }

  /* Overlay (popup) */
  .overlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:16px;
    z-index:1200;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease-out;
  }
  .overlay.show{
    opacity:1;
    pointer-events:auto;
  }
  .overlay-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.45);
  }
  .overlay-card{
    position:relative;
    max-width:980px;
    width:100%;
    max-height:82vh;
    background:var(--bg);
    border-radius:18px;
    border:1px solid var(--line);
    box-shadow:0 18px 45px rgba(0,0,0,.55);
    padding:10px 12px 14px;
    display:flex;
    flex-direction:column;
    transform:translateY(8px);
    opacity:0;
    transition:transform .2s ease-out, opacity .2s ease-out;
  }
  .overlay.show .overlay-card{
    transform:translateY(0);
    opacity:1;
  }
  .overlay-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:6px;
  }
  .overlay-body{
    overflow-y:auto;
    padding-right:4px;
    margin-top:4px;
  }
</style>
</head>
<body>
<header class="topbar">
  <div style="display:flex;align-items:center;gap:8px;">
    <span style="font-size:1.2rem">üìä</span>
    <h1>Statistieken</h1>
  </div>
  <button class="btn ghost small" id="backBtn">‚Üê Terug</button>
</header>

<main>
  <!-- Samenvatting -->
  <section class="card">
    <div class="card-header">
      <h2>Overzicht</h2>
      <span class="small muted" id="lastUpdated"></span>
    </div>
    <div class="kpi-row">
      <div class="kpi-pill">Avonden: <b id="kSessions">0</b></div>
      <div class="kpi-pill">Unieke spelers: <b id="kPlayers">0</b></div>
      <div class="kpi-pill">Totale inzet: <b id="kTotalStake">‚Ç¨ 0,00</b></div>
      <div class="kpi-pill">Gem. inzet/avond: <b id="kAvgStake">‚Ç¨ 0,00</b></div>
    </div>
  </section>

  <!-- Leuke stats / highlights -->
  <section class="card">
    <div class="card-header">
      <h2>Leuke stats</h2>
      <span class="small muted">Hoogte- en dieptepunten</span>
    </div>
    <div id="funStats" class="highlights small"></div>
  </section>

  <!-- Leaderboard -->
  <section class="card">
    <div class="card-header">
      <h2>Leaderboard (totaal)</h2>
      <span class="small muted">Gesorteerd op totale winst</span>
    </div>
    <div id="leaderboard" class="leaderboard-list small">
      <p class="small muted">Nog geen data opgeslagen.</p>
    </div>
  </section>

  <!-- Grafieken -->
  <section class="card">
    <div class="card-header">
      <h2>Grafieken</h2>
      <span class="small muted">Trends per speler &amp; totaal</span>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="chart-block">
        <div class="small muted">Totaal inzet per avond</div>
        <div class="chart-box">
          <canvas id="chartTotalPerSession"></canvas>
        </div>
      </div>
      <div class="chart-block">
        <div class="small muted">Cumulatief per speler (top 5)</div>
        <div class="chart-box large">
          <canvas id="chartPlayerCumulative"></canvas>
        </div>
      </div>
    </div>
    <div style="margin-top:6px;display:flex;justify-content:center">
      <button id="chartsMoreBtn" class="btn small ghost">Toon alle grafieken‚Ä¶</button>
    </div>
  </section>

  <!-- Geschiedenis -->
  <section class="card">
    <div class="card-header">
      <h2>Geschiedenis</h2>
      <span class="small muted" id="historyCount"></span>
    </div>
    <div id="historyList" class="small">
      <p class="small muted">Nog geen avonden opgeslagen.</p>
    </div>
  </section>

  <!-- Back-up / Import -->
  <section class="card">
    <div class="card-header">
      <h2>Back-up</h2>
      <span class="small muted">Exporteer of importeer alle data</span>
    </div>
    <div class="backup-row">
      <button id="exportBtn" class="btn small">üíæ Backup nu (Export)</button>
      <label class="btn small ghost">
        üìÇ Importeren
        <input id="importInput" type="file" accept="application/json" style="display:none">
      </label>
      <span id="backupStatus" class="small muted"></span>
    </div>
  </section>
</main>

<!-- Overlay voor "toon alles" + speler details + grafieken -->
<div id="overlay" class="overlay">
  <div class="overlay-backdrop"></div>
  <div class="overlay-card">
    <div class="overlay-header">
      <h2 id="overlayTitle">Overzicht</h2>
      <button class="btn small ghost" id="overlayClose">Sluit</button>
    </div>
    <div id="overlayBody" class="overlay-body"></div>
  </div>
</div>

<script>
const DB_NAME = 'poker_split_history_v1';
const STORE   = 'sessions';
let db;

let currentSessions = [];
let currentPlayerStats = [];

let chartTotalPerSession = null;
let chartPlayerCumulative = null;
let chartPlayerDetail = null;
let overlayCharts = [];

// overlay mode + geschiedenis (voor terug van speler -> alle spelers)
let overlayMode = 'none'; // 'none' | 'leaderboardAll' | 'historyAll' | 'playerDetail' | 'chartsAll' | 'generic'
let overlayHistory = null;

// ===== Utils
function euro(n){ return (n||0).toLocaleString('nl-NL',{style:'currency',currency:'EUR'}); }
function fmtDateShort(iso){
  const d=new Date(iso);
  if(isNaN(d)) return iso;
  return d.toLocaleDateString('nl-NL',{day:'2-digit',month:'2-digit',year:'2-digit'});
}
function fmtTimeShort(iso){
  const d=new Date(iso);
  if(isNaN(d)) return '';
  return d.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
}

// ===== DB helpers
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = (e)=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE,{keyPath:'sessionId'});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}

async function getAllSessions(){
  db = db || await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,'readonly');
    const store=tx.objectStore(STORE);
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror = ()=>reject(req.error);
  });
}

async function deleteSession(sessionId){
  db = db || await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).delete(sessionId);
    tx.oncomplete=resolve;
    tx.onerror=()=>reject(tx.error);
  });
}

// ===== Stats builders
function buildPlayerStats(sessions){
  const map = new Map();
  sessions.forEach(sess=>{
    (sess.players||[]).forEach(p=>{
      const name = p.name || 'Onbekend';
      const net  = typeof p.net === 'number' ? p.net : (Number(p.end||0) - Number(p.buyin||0));
      if(!map.has(name)){
        map.set(name,{
          name,
          nets:[],
          total:0,
          wins:0,
          losses:0,
          numSessions:0,
          maxWin:-Infinity,
          maxLoss:Infinity
        });
      }
      const s = map.get(name);
      s.nets.push(net);
      s.total += net;
      if(net>0) s.wins++;
      if(net<0) s.losses++;
      s.numSessions++;
      if(net>s.maxWin) s.maxWin=net;
      if(net<s.maxLoss) s.maxLoss=net;
    });
  });

  return Array.from(map.values()).map(s=>{
    const n = s.nets.length || 1;
    const mean = s.total / n;
    const variance = s.nets.reduce((a,x)=>a+Math.pow(x-mean,2),0)/n;
    const stdev = Math.sqrt(variance);
    const winRate = s.numSessions ? Math.round((s.wins/s.numSessions)*100) : 0;
    return {
      name:s.name,
      total:s.total,
      numSessions:s.numSessions,
      avg:mean,
      winRate,
      maxWin:(s.maxWin===-Infinity?0:s.maxWin),
      maxLoss:(s.maxLoss===Infinity?0:s.maxLoss),
      stdev
    };
  }).sort((a,b)=>b.total-a.total);
}

// ===== Leaderboard helpers
function createLeaderboardMarkup(players){
  if(!players.length){
    return '<p class="small muted">Nog geen data opgeslagen.</p>';
  }
  return players.map(p=>`
    <div class="player-card" data-player="${p.name}">
      <div class="pc-header">
        <div class="pc-name">${p.name}</div>
        <div class="pc-total ${p.total>=0?'pos':'neg'}">${euro(p.total)}</div>
      </div>
      <div class="pc-row">
        <span>Avonden: <b>${p.numSessions}</b></span>
        <span>Gem./avond: <b>${euro(p.avg)}</b></span>
        <span>Win-rate: <b>${p.winRate}%</b></span>
      </div>
      <div class="pc-row">
        <span>Max winst: <b>${euro(p.maxWin)}</b></span>
        <span>Max verlies: <b>${euro(p.maxLoss)}</b></span>
        <span>Stdev: <b>${euro(p.stdev)}</b></span>
      </div>
    </div>
  `).join('');
}

function renderLeaderboard(players){
  const wrap = document.getElementById('leaderboard');
  wrap.innerHTML='';
  if(!players.length){
    wrap.innerHTML = '<p class="small muted">Nog geen data opgeslagen.</p>';
    return;
  }
  const shortList = players.slice(0,5);
  wrap.innerHTML = createLeaderboardMarkup(shortList);

  if(players.length > 5){
    const more = document.createElement('div');
    more.style.marginTop='6px';
    more.style.display='flex';
    more.style.justifyContent='center';
    more.innerHTML = '<button class="btn small ghost" id="leaderboardMoreBtn">Toon alles‚Ä¶</button>';
    wrap.appendChild(more);
    document.getElementById('leaderboardMoreBtn').addEventListener('click', ()=>{
      openOverlay('Alle spelers (leaderboard)', createLeaderboardMarkup(players), 'leaderboardAll');
    });
  }
}

// ===== Summary & fun stats
function renderSummary(sessions, playerStats){
  const kSessions=document.getElementById('kSessions');
  const kPlayers=document.getElementById('kPlayers');
  const kTotalStake=document.getElementById('kTotalStake');
  const kAvgStake=document.getElementById('kAvgStake');
  const lastUpdated=document.getElementById('lastUpdated');

  kSessions.textContent = sessions.length;
  kPlayers.textContent  = playerStats.length;

  let totalStake = 0;
  sessions.forEach(sess=>{
    totalStake += (sess.players||[]).reduce((a,p)=>a + Number(p.buyin||0),0);
  });
  const avgStake = sessions.length ? totalStake / sessions.length : 0;

  kTotalStake.textContent = euro(totalStake);
  kAvgStake.textContent   = euro(avgStake);

  if(sessions.length){
    const latest = sessions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
    lastUpdated.textContent = 'Laatste: '+fmtDateShort(latest.date)+' '+fmtTimeShort(latest.date);
  }else{
    lastUpdated.textContent = 'Nog geen data';
  }
}

function renderFunStats(sessions, playerStats){
  const el = document.getElementById('funStats');
  if(!el) return;
  if(!sessions.length){
    el.textContent = 'Nog geen highlights.';
    return;
  }

  let bestStake = null;
  let bestWin = null;
  let worstLoss = null;
  let biggestTable = null;

  sessions.forEach(sess=>{
    const players = sess.players||[];
    const totalBuyin = players.reduce((a,p)=>a+Number(p.buyin||0),0);
    if(!bestStake || totalBuyin > bestStake.total){
      bestStake = { total: totalBuyin, date: sess.date };
    }
    if(!biggestTable || players.length > biggestTable.count){
      biggestTable = { count: players.length, date: sess.date, desc: sess.desc||'Pokeravond' };
    }
    players.forEach(p=>{
      const net = typeof p.net==='number' ? p.net : (Number(p.end||0)-Number(p.buyin||0));
      if(net>0 && (!bestWin || net>bestWin.amount)){
        bestWin = { amount:net, name:p.name, date:sess.date };
      }
      if(net<0 && (!worstLoss || net<worstLoss.amount)){
        worstLoss = { amount:net, name:p.name, date:sess.date };
      }
    });
  });

  // extra stats op basis van playerStats
  const mostSessions = playerStats.slice().sort((a,b)=>b.numSessions-a.numSessions)[0];
  const bestAvg = playerStats
    .filter(p=>p.numSessions>=3)
    .slice()
    .sort((a,b)=>b.avg-a.avg)[0];
  const mostSwing = playerStats
    .filter(p=>p.numSessions>=3)
    .slice()
    .sort((a,b)=>b.stdev-a.stdev)[0];

  const lines=[];

  if(bestWin){
    lines.push(`üî• Grootste winst: <b>${bestWin.name}</b> (${euro(bestWin.amount)}) ‚Äî ${fmtDateShort(bestWin.date)}`);
  }
  if(worstLoss){
    lines.push(`üí£ Grootste verlies: <b>${worstLoss.name}</b> (${euro(worstLoss.amount)}) ‚Äî ${fmtDateShort(worstLoss.date)}`);
  }
  if(bestStake){
    lines.push(`üèÜ Hoogste inzet-avond: <b>${fmtDateShort(bestStake.date)}</b> (${euro(bestStake.total)})`);
  }
  if(mostSessions){
    lines.push(`üëë Meest gespeelde speler: <b>${mostSessions.name}</b> (${mostSessions.numSessions} avonden)`);
  }
  if(bestAvg){
    lines.push(`üìà Beste gemiddelde (‚â•3 avonden): <b>${bestAvg.name}</b> (${euro(bestAvg.avg)} per avond)`);
  }
  if(mostSwing){
    lines.push(`üé¢ Meest swingende speler (‚â•3 avonden): <b>${mostSwing.name}</b> (œÉ ‚âà ${euro(mostSwing.stdev)})`);
  }
  if(biggestTable){
    lines.push(`üë• Grootste tafel: <b>${biggestTable.count} spelers</b> ‚Äî ${fmtDateShort(biggestTable.date)}`);
  }

  // mini heatmap van inzet per avond
  if(sessions.length>=2){
    const sorted = sessions.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
    const totals = sorted.map(s=>(s.players||[]).reduce((a,p)=>a+Number(p.buyin||0),0));
    const maxStake = Math.max(...totals, 1);
    const dots = sorted.map((s,idx)=>{
      const level = totals[idx]/maxStake;
      const title = `${fmtDateShort(s.date)} ‚Äî ${euro(totals[idx])}`;
      return `<span class="heat-dot" title="${title}" style="--level:${level.toFixed(2)}"></span>`;
    }).join('');
    lines.push(`
      <div class="heatmap">
        <div>üî• Inzet-intensiteit over avonden</div>
        <div class="heat-row">${dots}</div>
      </div>
    `);
  }

  if(!lines.length){
    el.textContent='Nog geen highlights.';
  }else{
    el.innerHTML = lines.map(l=> l.startsWith('<div class="heatmap">') ? l : `<div>${l}</div>`).join('');
  }
}

// ===== History helpers
function createHistoryMarkup(sessions){
  return sessions.map(sess=>{
    const totalBuyin = (sess.players||[]).reduce((a,p)=>a + Number(p.buyin||0),0);
    return `
      <details class="session">
        <summary>
          <div class="session-main">
            <div class="session-line"><b>${fmtDateShort(sess.date)}</b> ‚Ä¢ ${sess.desc||'Pokeravond'}</div>
            <div class="session-line muted">
              ${(sess.players||[]).length} spelers ‚Ä¢ ${fmtTimeShort(sess.date)} ‚Ä¢ Inzet: ${euro(totalBuyin)}
            </div>
          </div>
          <div class="session-total">${euro(totalBuyin)}</div>
        </summary>
        <div class="session-body">
          <table class="session-table">
            <thead>
              <tr><th>Speler</th><th>Inzet</th><th>Eind</th><th>Netto</th></tr>
            </thead>
            <tbody>
              ${(sess.players||[]).map(p=>{
                const net = typeof p.net==='number'?p.net:(p.end-p.buyin);
                return `<tr>
                  <td>${p.name}</td>
                  <td class="amount">${euro(p.buyin)}</td>
                  <td class="amount">${euro(p.end)}</td>
                  <td class="amount">${euro(net)}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
          <div style="margin-top:6px;display:flex;justify-content:flex-end">
            <button class="btn small danger" data-del-session="${sess.sessionId}">Verwijder avond</button>
          </div>
        </div>
      </details>
    `;
  }).join('');
}

function renderHistory(sessions){
  const wrap=document.getElementById('historyList');
  wrap.innerHTML='';
  const countEl=document.getElementById('historyCount');

  if(!sessions.length){
    wrap.innerHTML = '<p class="small muted">Nog geen avonden opgeslagen.</p>';
    countEl.textContent='';
    return;
  }

  const sorted = sessions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
  const shortList = sorted.slice(0,3);
  wrap.innerHTML = createHistoryMarkup(shortList);

  countEl.textContent = `${sorted.length} avonden`;

  if(sorted.length > 3){
    const more = document.createElement('div');
    more.style.marginTop='6px';
    more.style.display='flex';
    more.style.justifyContent='center';
    more.innerHTML = '<button class="btn small ghost" id="historyMoreBtn">Toon alles‚Ä¶</button>';
    wrap.appendChild(more);
    document.getElementById('historyMoreBtn').addEventListener('click', ()=>{
      openOverlay('Alle avonden', createHistoryMarkup(sorted), 'historyAll');
    });
  }
}

// ===== Overlay helpers
function resetPlayerChart(){
  if(chartPlayerDetail){
    chartPlayerDetail.destroy();
    chartPlayerDetail = null;
  }
}
function resetOverlayCharts(){
  if(overlayCharts && overlayCharts.length){
    overlayCharts.forEach(ch=>{ try{ ch.destroy(); }catch(e){} });
    overlayCharts = [];
  }
}

function openOverlay(title, html, mode='generic'){
  if(mode !== 'playerDetail'){
    resetPlayerChart();
  }
  if(mode !== 'chartsAll'){
    resetOverlayCharts();
  }
  if(mode !== 'playerDetail'){
    overlayHistory = null;
  }
  overlayMode = mode;
  const ov = document.getElementById('overlay');
  document.getElementById('overlayTitle').textContent = title;
  document.getElementById('overlayBody').innerHTML = html;
  ov.classList.add('show');
}

function closeOverlay(){
  resetPlayerChart();
  resetOverlayCharts();
  overlayMode = 'none';
  overlayHistory = null;
  const ov = document.getElementById('overlay');
  ov.classList.remove('show');
  document.getElementById('overlayBody').innerHTML='';
}

document.getElementById('overlayClose').addEventListener('click', closeOverlay);
document.getElementById('overlay').addEventListener('click',(e)=>{
  if(e.target.classList.contains('overlay-backdrop')) closeOverlay();
});

// ===== Player detail overlay
function buildPlayerDetailChart(labels,data){
  const canvas = document.getElementById('playerDetailChart');
  if(!canvas || !labels.length) return;
  const ctx = canvas.getContext('2d');
  chartPlayerDetail = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Cumulatieve winst',
        data,
        tension:0.25
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{x:{display:false}}
    }
  });
}

function openPlayerDetail(name){
  resetPlayerChart();

  const sessions = currentSessions || [];
  const playerEntries=[];
  sessions.forEach(sess=>{
    const pl=(sess.players||[]).find(p=>p.name===name);
    if(pl){
      const net = typeof pl.net==='number'?pl.net:(Number(pl.end||0)-Number(pl.buyin||0));
      playerEntries.push({
        date:sess.date,
        desc:sess.desc||'Pokeravond',
        buyin:Number(pl.buyin||0),
        end:Number(pl.end||0),
        net
      });
    }
  });

  if(!playerEntries.length){
    openOverlay('Speler: '+name, '<p class="small muted">Nog geen data voor deze speler.</p>','playerDetail');
    return;
  }

  const sorted = playerEntries.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  const num = sorted.length;
  const total = sorted.reduce((a,e)=>a+e.net,0);
  const avg = total/num;
  let wins=0, losses=0;
  let maxWin=-Infinity, maxLoss=Infinity;
  sorted.forEach(e=>{
    if(e.net>0) wins++;
    if(e.net<0) losses++;
    if(e.net>maxWin) maxWin=e.net;
    if(e.net<maxLoss) maxLoss=e.net;
  });
  const winRate = num ? Math.round((wins/num)*100) : 0;
  if(maxWin===-Infinity) maxWin=0;
  if(maxLoss===Infinity) maxLoss=0;

  // streaks
  let bestWinStreak=0, curWinStreak=0;
  let bestLossStreak=0, curLossStreak=0;
  sorted.forEach(e=>{
    if(e.net>0){
      curWinStreak++; bestWinStreak=Math.max(bestWinStreak,curWinStreak);
      curLossStreak=0;
    }else if(e.net<0){
      curLossStreak++; bestLossStreak=Math.max(bestLossStreak,curLossStreak);
      curWinStreak=0;
    }else{
      curWinStreak=0; curLossStreak=0;
    }
  });

  const labels = sorted.map(e=>fmtDateShort(e.date));
  const cumData=[];
  let cum=0;
  sorted.forEach(e=>{ cum+=e.net; cumData.push(cum); });

  // als we vanuit "Alle spelers" komen, sla die view op om terug te kunnen
  if(overlayMode === 'leaderboardAll' && currentPlayerStats.length){
    overlayHistory = {
      title: 'Alle spelers (leaderboard)',
      html: createLeaderboardMarkup(currentPlayerStats),
      mode: 'leaderboardAll'
    };
  } else {
    overlayHistory = null;
  }

  const detailHtml = `
    <div class="player-card" data-player-toggle="${name}" style="margin:0 0 8px 0;">
      <div class="pc-header">
        <div class="pc-name">${name}</div>
        <div class="pc-total ${total>=0?'pos':'neg'}">${euro(total)}</div>
      </div>
      <div class="pc-row">
        <span>Avonden: <b>${num}</b></span>
        <span>Gem./avond: <b>${euro(avg)}</b></span>
        <span>Win-rate: <b>${winRate}%</b></span>
      </div>
      <div class="pc-row">
        <span>Langste win-streak: <b>${bestWinStreak}</b></span>
        <span>Langste verlies-streak: <b>${bestLossStreak}</b></span>
        <span>Max winst: <b>${euro(maxWin)}</b></span>
        <span>Max verlies: <b>${euro(maxLoss)}</b></span>
      </div>
    </div>
    <div class="chart-block" style="margin:8px 0 10px">
      <div class="small muted">Cumulatieve winst</div>
      <div class="chart-box" style="height:200px;">
        <canvas id="playerDetailChart"></canvas>
      </div>
    </div>
    <div class="small muted" style="margin-bottom:4px">Avonden</div>
    ${sorted.map(e=>`
      <div class="player-card" style="margin:4px 0;cursor:default;">
        <div class="pc-header">
          <div class="pc-name" style="font-size:.95rem">${fmtDateShort(e.date)} ‚Ä¢ ${e.desc}</div>
          <div class="pc-total ${e.net>=0?'pos':'neg'}">${euro(e.net)}</div>
        </div>
        <div class="pc-row">
          <span>Inzet: <b>${euro(e.buyin)}</b></span>
          <span>Eind: <b>${euro(e.end)}</b></span>
        </div>
      </div>
    `).join('')}
  `;

  openOverlay('Speler: '+name, detailHtml, 'playerDetail');
  buildPlayerDetailChart(labels,cumData);
}

// ===== Charts op hoofd-pagina
function buildCharts(sessions, playerStats){
  const canvasTotal = document.getElementById('chartTotalPerSession');
  const canvasPlayers = document.getElementById('chartPlayerCumulative');
  if(!canvasTotal || !canvasPlayers) return;

  const ctxTotal = canvasTotal.getContext('2d');
  const ctxPlayers = canvasPlayers.getContext('2d');

  const sortedSessions = sessions.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  const labels = sortedSessions.map(s=>fmtDateShort(s.date));

  const totals = sortedSessions.map(s=>(s.players||[]).reduce((a,p)=>a+Number(p.buyin||0),0));

  if(chartTotalPerSession) chartTotalPerSession.destroy();
  chartTotalPerSession = new Chart(ctxTotal,{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Inzet per avond',
        data:totals,
        tension:0.25
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{x:{display:false}}
    }
  });

  const topPlayers = playerStats.slice(0,5);
  const datasets=[];
  topPlayers.forEach(player=>{
    const cumData=[];
    let cum=0;
    sortedSessions.forEach(sess=>{
      const pl = (sess.players||[]).find(sp=>sp.name===player.name);
      const net = pl ? (typeof pl.net==='number'?pl.net:(Number(pl.end||0)-Number(pl.buyin||0))) : 0;
      cum += net;
      cumData.push(cum);
    });
    datasets.push({
      label:player.name,
      data:cumData,
      tension:0.25
    });
  });

  if(chartPlayerCumulative) chartPlayerCumulative.destroy();
  chartPlayerCumulative = new Chart(ctxPlayers,{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'bottom'}},
      scales:{x:{display:false}}
    }
  });
}

// ===== Charts in overlay ("Toon alle grafieken")
function createChartsOverlayMarkup(sessions, playerStats){
  if(!sessions.length){
    return '<p class="small muted">Nog geen data om grafieken te tonen.</p>';
  }
  return `
    <div class="chart-block" style="margin-bottom:10px;">
      <div class="small muted">Totaal inzet per avond</div>
      <div class="chart-box large">
        <canvas id="ovChartTotal"></canvas>
      </div>
    </div>
    <div class="chart-block" style="margin-bottom:10px;">
      <div class="small muted">Totale winst per speler</div>
      <div class="chart-box large">
        <canvas id="ovChartNetPerPlayer"></canvas>
      </div>
    </div>
    <div class="chart-block" style="margin-bottom:10px;">
      <div class="small muted">Totale inzet per speler</div>
      <div class="chart-box large">
        <canvas id="ovChartStakePerPlayer"></canvas>
      </div>
    </div>
    <div class="chart-block" style="margin-bottom:10px;">
      <div class="small muted">Win-rate per speler</div>
      <div class="chart-box large">
        <canvas id="ovChartWinratePerPlayer"></canvas>
      </div>
    </div>
  `;
}

function buildChartsOverlay(sessions, playerStats){
  if(!sessions.length) return;

  const sortedSessions = sessions.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  const labelsSessions = sortedSessions.map(s=>fmtDateShort(s.date));
  const totals = sortedSessions.map(s=>(s.players||[]).reduce((a,p)=>a+Number(p.buyin||0),0));

  // inzet per avond (overlay)
  const ctxTotal = document.getElementById('ovChartTotal')?.getContext('2d');
  if(ctxTotal){
    overlayCharts.push(new Chart(ctxTotal,{
      type:'line',
      data:{
        labels:labelsSessions,
        datasets:[{
          label:'Inzet per avond',
          data:totals,
          tension:0.25
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{display:true}}
      }
    }));
  }

  // totale winst per speler
  const ctxNet = document.getElementById('ovChartNetPerPlayer')?.getContext('2d');
  if(ctxNet && playerStats.length){
    const labels = playerStats.map(p=>p.name);
    const data = playerStats.map(p=>p.total);
    overlayCharts.push(new Chart(ctxNet,{
      type:'bar',
      data:{
        labels,
        datasets:[{label:'Totale winst',data}]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{ticks:{autoSkip:false}}}
      }
    }));
  }

  // totale inzet per speler
  const ctxStake = document.getElementById('ovChartStakePerPlayer')?.getContext('2d');
  if(ctxStake){
    const stakeMap = new Map();
    sessions.forEach(sess=>{
      (sess.players||[]).forEach(p=>{
        const name = p.name || 'Onbekend';
        const prev = stakeMap.get(name) || 0;
        stakeMap.set(name, prev + Number(p.buyin||0));
      });
    });
    const stakeArr = Array.from(stakeMap.entries()).map(([name,value])=>({name,value}));
    stakeArr.sort((a,b)=>b.value-a.value);
    const labels = stakeArr.map(x=>x.name);
    const data = stakeArr.map(x=>x.value);

    overlayCharts.push(new Chart(ctxStake,{
      type:'bar',
      data:{labels,datasets:[{label:'Totale inzet',data}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{ticks:{autoSkip:false}}}
      }
    }));
  }

  // win-rate per speler
  const ctxWin = document.getElementById('ovChartWinratePerPlayer')?.getContext('2d');
  if(ctxWin && playerStats.length){
    const labels = playerStats.map(p=>p.name);
    const data = playerStats.map(p=>p.winRate);
    overlayCharts.push(new Chart(ctxWin,{
      type:'bar',
      data:{labels,datasets:[{label:'Win-rate (%)',data}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          y:{beginAtZero:true,max:100},
          x:{ticks:{autoSkip:false}}
        }
      }
    }));
  }
}

// ===== Backup export/import
async function exportBackup(){
  const sess = await getAllSessions();
  const payload = {version:1,sessions:sess};
  const json = JSON.stringify(payload,null,2);
  const blob = new Blob([json],{type:'application/json'});
  const now = new Date();
  const pad=n=>String(n).padStart(2,'0');
  const name = `poker_backup_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.json`;

  const status=document.getElementById('backupStatus');

  try{
    if(navigator.share && navigator.canShare && navigator.canShare({files:[new File([blob],name,{type:'application/json'})]})){
      const file = new File([blob],name,{type:'application/json'});
      await navigator.share({
        title:'Poker Split backup',
        files:[file]
      });
      status.textContent='Backup gedeeld ‚úîÔ∏é';
      return;
    }
  }catch(e){
    // fallback naar download
  }

  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  status.textContent='Backup gedownload ‚úîÔ∏é';
}

async function importBackup(file){
  const status=document.getElementById('backupStatus');
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    const sessions = Array.isArray(data.sessions)?data.sessions:[];
    if(!sessions.length){ status.textContent='Geen sessies in bestand.'; return; }

    db = db || await openDB();
    await new Promise((resolve,reject)=>{
      const tx=db.transaction(STORE,'readwrite');
      const store=tx.objectStore(STORE);
      sessions.forEach(s=>store.put(s)); // dedupe op sessionId
      tx.oncomplete=resolve;
      tx.onerror=()=>reject(tx.error);
    });

    const all = await getAllSessions();
    const stats = buildPlayerStats(all);
    currentSessions = all;
    currentPlayerStats = stats;
    renderSummary(all,stats);
    renderFunStats(all,stats);
    renderLeaderboard(stats);
    renderHistory(all);
    if(all.length){
      buildCharts(all,stats);
    }
    status.textContent='Import voltooid ‚úîÔ∏é';
  }catch(e){
    console.error(e);
    status.textContent='Import mislukt.';
  }
}

// ===== Init & global listeners
async function init(){
  try{
    const sessions = await getAllSessions();
    const stats = buildPlayerStats(sessions);
    currentSessions = sessions;
    currentPlayerStats = stats;
    renderSummary(sessions,stats);
    renderFunStats(sessions,stats);
    renderLeaderboard(stats);
    renderHistory(sessions);
    const chartsMoreBtn = document.getElementById('chartsMoreBtn');
    if(!sessions.length && chartsMoreBtn){
      chartsMoreBtn.style.display = 'none';
    }
    if(sessions.length){
      buildCharts(sessions,stats);
    }
  }catch(e){
    console.error(e);
  }
}

document.getElementById('backBtn').addEventListener('click', ()=>{ location.href='index.html'; });
document.getElementById('exportBtn').addEventListener('click', ()=>{ exportBackup(); });
document.getElementById('importInput').addEventListener('change', (e)=>{
  const f=e.target.files && e.target.files[0];
  if(f) importBackup(f);
});

// "Toon alle grafieken"
document.getElementById('chartsMoreBtn').addEventListener('click', ()=>{
  const html = createChartsOverlayMarkup(currentSessions, currentPlayerStats);
  openOverlay('Alle grafieken', html, 'chartsAll');
  buildChartsOverlay(currentSessions, currentPlayerStats);
});

// Speler-kliks (leaderboard + overlay-leaderboard)
document.addEventListener('click',(e)=>{
  const card = e.target.closest('.player-card[data-player]');
  if(card){
    const name = card.getAttribute('data-player');
    if(name){ openPlayerDetail(name); }
  }
});

// Spelerkaart in detail-overlay: nog een keer klikken = terug naar lijst (indien beschikbaar) of overlay sluiten
document.addEventListener('click',(e)=>{
  const toggleCard = e.target.closest('[data-player-toggle]');
  if(!toggleCard) return;
  if(overlayMode === 'playerDetail' && overlayHistory){
    openOverlay(overlayHistory.title, overlayHistory.html, overlayHistory.mode);
    overlayHistory = null;
  } else if(overlayMode === 'playerDetail'){
    closeOverlay();
  }
});

// Delete-knoppen (zowel in main als in overlay)
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-del-session]');
  if(!btn) return;
  const id = btn.getAttribute('data-del-session');
  if(!id) return;
  if(!confirm('Weet je zeker dat je deze avond wilt verwijderen? Dit kan niet ongedaan worden gemaakt.')) return;
  try{
    await deleteSession(id);
    const sessions = await getAllSessions();
    const stats = buildPlayerStats(sessions);
    currentSessions = sessions;
    currentPlayerStats = stats;
    renderSummary(sessions,stats);
    renderFunStats(sessions,stats);
    renderLeaderboard(stats);
    renderHistory(sessions);
    if(sessions.length){
      buildCharts(sessions,stats);
    }

    // overlay updaten indien nodig
    const ov = document.getElementById('overlay');
    if(ov.classList.contains('show')){
      const title = document.getElementById('overlayTitle').textContent;
      if(title.startsWith('Alle avonden')){
        const sorted = sessions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
        document.getElementById('overlayBody').innerHTML = createHistoryMarkup(sorted);
      }else if(title.startsWith('Alle spelers')){
        document.getElementById('overlayBody').innerHTML = createLeaderboardMarkup(stats);
      }else if(title.startsWith('Speler: ')){
        const name = title.replace('Speler: ','').trim();
        openPlayerDetail(name);
      }else if(title.startsWith('Alle grafieken')){
        const html = createChartsOverlayMarkup(sessions, stats);
        document.getElementById('overlayBody').innerHTML = html;
        resetOverlayCharts();
        buildChartsOverlay(sessions, stats);
      }
    }
  }catch(err){
    alert('Verwijderen mislukt.');
  }
});

init();
</script>
</body>
</html>
